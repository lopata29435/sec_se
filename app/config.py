# Конфигурация безопасности — Habit Tracker API
# Этот файл демонстрирует контроли безопасности из модели угроз

import os

# =============================================================================
# Формат ошибок
# =============================================================================
# RFC 7807 по умолчанию
USE_RFC7807_ERRORS = os.getenv("USE_RFC7807_ERRORS", "true").lower() == "true"

# =============================================================================
# Ограничение частоты запросов (NFR-03, R02)
# Смягчает: T1.4 (DDoS), T8.3 (Флуд ошибками), T10.3 (Флуд отслеживанием)
# =============================================================================
RATE_LIMIT_ENABLED = True  # Установить True для активации
RATE_LIMIT_REQUESTS_PER_MINUTE = 100  # На IP адрес
RATE_LIMIT_HEALTH_CHECK_MULTIPLIER = 10  # /health получает в 10 раз больший лимит

# =============================================================================
# Квоты ресурсов (R06)
# Смягчает: T5.3 (Неограниченные привычки), T15.3 (Исчерпание памяти)
# =============================================================================
MAX_HABITS_PER_USER = 100
MAX_TRACKING_RECORDS_PER_HABIT = 10000
MAX_REQUEST_SIZE_MB = 1

# =============================================================================
# Конфигурация HTTPS/TLS (NFR-06, R03)
# Смягчает: T1.2 (MITM), T1.3 (Утечка информации)
# =============================================================================
HTTPS_ONLY = False  # Установить True в продакшене
HSTS_MAX_AGE = 31536000  # 1 год в секундах
HSTS_INCLUDE_SUBDOMAINS = True

# =============================================================================
# Обработка ошибок (NFR-02, R04)
# Смягчает: T8.1 (Утечка stack trace), T7.1 (Детали реализации)
# =============================================================================
SHOW_STACK_TRACES = False  # НИКОГДА не устанавливать True в продакшене
MASK_INTERNAL_ERRORS = True
ERROR_LOG_LEVEL = "INFO"  # DEBUG, INFO, WARNING, ERROR, CRITICAL

# =============================================================================
# Логирование аудита (R07)
# Смягчает: T5.4 (Отказ от действий), T13.3 (Отказ от обновлений)
# =============================================================================
AUDIT_LOG_ENABLED = False  # Установить True для активации
AUDIT_LOG_ACTIONS = ["CREATE", "UPDATE", "DELETE"]  # Действия для логирования
AUDIT_LOG_RETENTION_DAYS = 90

# =============================================================================
# CORS (Cross-Origin Resource Sharing)
# =============================================================================
CORS_ENABLED = True
CORS_ALLOWED_ORIGINS = [
    "http://localhost:3000",  # React dev сервер
    "http://localhost:8080",  # Vue dev сервер
]
CORS_ALLOW_CREDENTIALS = True
CORS_ALLOWED_METHODS = ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
CORS_ALLOWED_HEADERS = ["*"]

# =============================================================================
# Заголовки безопасности
# =============================================================================
SECURITY_HEADERS = {
    "X-Content-Type-Options": "nosniff",
    "X-Frame-Options": "DENY",
    "X-XSS-Protection": "1; mode=block",
    "Referrer-Policy": "strict-origin-when-cross-origin",
    "Content-Security-Policy": "default-src 'self'",
}

# =============================================================================
# Лимиты валидации входных данных (NFR-01)
# =============================================================================
MAX_HABIT_NAME_LENGTH = 100
MAX_HABIT_DESCRIPTION_LENGTH = 500
MAX_ITEM_NAME_LENGTH = 100

# =============================================================================
# Аутентификация/Авторизация (R01, R05) — ПОКА НЕ РЕАЛИЗОВАНО
# =============================================================================
AUTH_ENABLED = False  # TODO: Включить после реализации JWT
AUTH_JWT_SECRET_KEY = (
    "REPLACE_WITH_SECURE_RANDOM_KEY"  # noqa: S105 # Использовать переменную окружения!
)
AUTH_JWT_ALGORITHM = "HS256"
AUTH_JWT_EXPIRATION_MINUTES = 60

# =============================================================================
# База данных (R12)
# =============================================================================
USE_PERSISTENT_DB = False  # True = PostgreSQL, False = In-Memory
DATABASE_URL = "postgresql://user:pass@localhost/habitdb"  # Для будущего использования

# =============================================================================
# Мониторинг и наблюдаемость
# =============================================================================
METRICS_ENABLED = False
METRICS_PORT = 9090
HEALTH_CHECK_TIMEOUT_SECONDS = 5

# =============================================================================
# Разработка vs Продакшн
# =============================================================================

ENVIRONMENT = os.getenv(
    "ENVIRONMENT", "development"
)  # development, staging, production

# Переопределение настроек для продакшена
if ENVIRONMENT == "production":
    RATE_LIMIT_ENABLED = True
    HTTPS_ONLY = True
    SHOW_STACK_TRACES = False
    MASK_INTERNAL_ERRORS = True
    AUDIT_LOG_ENABLED = True
    AUTH_ENABLED = True  # Когда будет реализовано
    USE_PERSISTENT_DB = True
