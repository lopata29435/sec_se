# ADR-002: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ In-Memory —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–ª—è MVP

**–î–∞—Ç–∞:** 2025-10-01
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–∏–Ω—è—Ç–æ (–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ)
**–ê–≤—Ç–æ—Ä:** SecDev Team
**–°–≤—è–∑–∞–Ω–Ω—ã–µ NFR:** NFR-12 (Persistence Planning), NFR-13 (Backup Strategy)
**–°–≤—è–∑–∞–Ω–Ω—ã–µ —Ä–∏—Å–∫–∏:** R06 (–ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–±–æ–µ)

---

## Context

–î–ª—è MVP —Ñ–∞–∑—ã Habit Tracker API —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–±—Ä–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–≤—ã—á–µ–∫ –∏ –∑–∞–ø–∏—Å–µ–π –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è. –ü—Ä–æ–µ–∫—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Ä–∞–Ω–Ω–µ–π —Å—Ç–∞–¥–∏–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –Ω–∞:
- –ë—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Ç–æ—Ç–∏–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Ç–µ—Ä–∞—Ü–∏–∏
- –ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å
- –§–æ–∫—É—Å –Ω–∞ –ª–æ–≥–∏–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞:**
- MVP –≤–µ—Ä—Å–∏—è 0.1.0
- –£—á–µ–±–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ secure development practices
- –û–∂–∏–¥–∞–µ–º—ã–π –æ–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö: <100 –ø—Ä–∏–≤—ã—á–µ–∫ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
- –°—Ä–æ–∫ MVP: 2-3 –Ω–µ–¥–µ–ª–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ö—Ä–∞–Ω–∏–ª–∏—â—É:**
- CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–∏–≤—ã—á–µ–∫ (—Å–æ–∑–¥–∞–Ω–∏–µ, —á—Ç–µ–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä (tracking records –≤–Ω—É—Ç—Ä–∏ habits)
- –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –ø–æ ID (O(1) lookup)
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤ –±—É–¥—É—â–µ–º

---

## Decision

**–í—ã–±—Ä–∞–Ω In-Memory Dictionary (Python `dict`)** –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è MVP —Ñ–∞–∑—ã.

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
1. **–°–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:** –ù—É–ª–µ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã, –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π —Å—Ç–∞—Ä—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
2. **–ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** O(1) –¥–æ—Å—Ç—É–ø –ø–æ –∫–ª—é—á—É, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–¥–µ—Ä–∂–µ–∫
4. **–ì–∏–±–∫–æ—Å—Ç—å:** –õ–µ–≥–∫–æ –∏–∑–º–µ–Ω—è—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–π
5. **–û–±—É—á–µ–Ω–∏–µ:** –§–æ–∫—É—Å –Ω–∞ API –ª–æ–≥–∏–∫–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –∞ –Ω–µ –Ω–∞ ORM

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
# app/main.py
_HABITS_DB: Dict[str, Dict[str, Any]] = {}
```

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- ‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- ‚ö†Ô∏è –ù–µ—Ç –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ (NFR-12 –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω –≤ MVP)
- ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –ø–∞–º—è—Ç–∏ (–¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤)
- ‚ö†Ô∏è –ù–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ (single-process only)

---

## Alternatives

### 1. PostgreSQL (–†–µ–ª—è—Ü–∏–æ–Ω–Ω–∞—è –ë–î)
**–ü–ª—é—Å—ã:**
- –ü–æ–ª–Ω–∞—è ACID-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- –ë–æ–≥–∞—Ç—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ (JOIN, –∞–≥—Ä–µ–≥–∞—Ü–∏—è)
- –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ JSON/JSONB –¥–ª—è –≥–∏–±—Ä–∏–¥–Ω—ã—Ö —Å—Ö–µ–º
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ NFR-12 (–ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏–∑ –∫–æ—Ä–æ–±–∫–∏)

**–ú–∏–Ω—É—Å—ã:**
- –¢—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ PostgreSQL —Å–µ—Ä–≤–µ—Ä–∞
- –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç—å Docker Compose (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä)
- –ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–π –ë–î (Alembic/Flyway)
- ORM overhead (SQLAlchemy) ‚Äî –±–æ–ª—å—à–µ –∫–æ–¥–∞
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ (—É—Å–ª–æ–∂–Ω—è–µ—Ç —Ç–µ—Å—Ç—ã)

**–ü–æ—á–µ–º—É –Ω–µ –≤—ã–±—Ä–∞–ª–∏ –¥–ª—è MVP:**
- –ò–∑–±—ã—Ç–æ—á–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å –¥–ª—è –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞
- –ó–∞–º–µ–¥–ª—è–µ—Ç –∏—Ç–µ—Ä–∞—Ü–∏–∏ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç —Å—Ö–µ–º—ã)
- –§–æ–∫—É—Å –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ secure coding, –Ω–µ –Ω–∞ –ë–î –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** Production —Ñ–∞–∑–∞ (Rollout Plan –Ω–∏–∂–µ)

### 2. SQLite (Embedded –ë–î)
**–ü–ª—é—Å—ã:**
- –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –±–µ–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
- SQL –∑–∞–ø—Ä–æ—Å—ã –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –§–∞–π–ª –ë–î –ª–µ–≥–∫–æ —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –º–∞–ª—ã—Ö/—Å—Ä–µ–¥–Ω–∏—Ö –Ω–∞–≥—Ä—É–∑–æ–∫

**–ú–∏–Ω—É—Å—ã:**
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏ (lock –Ω–∞ —Ñ–∞–π–ª)
- –ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö API
- –í—Å–µ –µ—â–µ —Ç—Ä–µ–±—É–µ—Ç ORM/SQL –ª–æ–≥–∏–∫—É
- –§–∞–π–ª–æ–≤—ã–π lock –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö

**–ü–æ—á–µ–º—É –Ω–µ –≤—ã–±—Ä–∞–ª–∏:**
- –ù–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ –Ω–∞–¥ in-memory –¥–ª—è MVP
- –í—Å–µ –µ—â–µ —Ç—Ä–µ–±—É–µ—Ç ORM –∫–æ–¥ (SQLAlchemy)
- –£—Å–ª–æ–∂–Ω—è–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–Ω—É–∂–µ–Ω cleanup —Ñ–∞–π–ª–æ–≤)

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è —Ñ–∞–∑–∞ –º–µ–∂–¥—É MVP –∏ Production

### 3. Redis (In-Memory Store)
**–ü–ª—é—Å—ã:**
- –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (in-memory + –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–ª–æ–∂–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö
- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (RDB/AOF)
- –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è

**–ú–∏–Ω—É—Å—ã:**
- –¢—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ Redis —Å–µ—Ä–≤–µ—Ä–∞
- –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—É—é —Å–ª–æ–∂–Ω–æ—Å—Ç—å
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ (–Ω–µ—Ç JOIN)
- –¢—Ä–µ–±—É–µ—Ç Redis-–∫–ª–∏–µ–Ω—Ç (redis-py)

**–ü–æ—á–µ–º—É –Ω–µ –≤—ã–±—Ä–∞–ª–∏:**
- Overkill –¥–ª—è MVP —Å –º–∞–ª—ã–º –æ–±—ä–µ–º–æ–º –¥–∞–Ω–Ω—ã—Ö
- –£—Å–ª–æ–∂–Ω—è–µ—Ç deployment (–µ—â–µ –æ–¥–∏–Ω —Å–µ—Ä–≤–∏—Å)
- –ù–µ –¥–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤ –¥–ª—è —É—á–µ–±–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ pub/sub

---

## Consequences

### –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ

1. **‚úÖ –ë—ã—Å—Ç—Ä–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞**
   - –ù—É–ª–µ–≤–æ–µ –≤—Ä–µ–º—è –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
   - –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π —Å—Ç–∞—Ä—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ API –ª–æ–≥–∏–∫–∏
   - MVP —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∑–∞ 1 –Ω–µ–¥–µ–ª—é –≤–º–µ—Å—Ç–æ 3

2. **‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**
   - –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ unit-—Ç–µ—Å—Ç—ã –±–µ–∑ –º–æ–∫–æ–≤ –ë–î
   - TestClient —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
   - 93.6% test coverage –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –±–µ–∑ —Å–ª–æ–∂–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

3. **‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
   - O(1) –¥–æ—Å—Ç—É–ø –ø–æ habit_id
   - –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–¥–µ—Ä–∂–µ–∫
   - p95 latency: 1.93ms –¥–ª—è GET /habits

4. **‚úÖ –ì–∏–±–∫–æ—Å—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö**
   - –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–π
   - –ë—ã—Å—Ç—Ä—ã–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏ –Ω–∞–¥ –º–æ–¥–µ–ª—è–º–∏
   - –°–≤–æ–±–æ–¥–∞ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ñ–æ—Ä–º–∞—Ç–∞–º–∏

### –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ

1. **‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ (NFR-12)**
   - –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ
   - –†–∏—Å–∫ R06: –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–±–æ–µ
   - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π, –ø–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ PostgreSQL

2. **‚ùå –ù–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (NFR-13)**
   - –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
   - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –§–∞–∑–∞ Production –≤–∫–ª—é—á–∞–µ—Ç PostgreSQL + –±—ç–∫–∞–ø—ã

3. **‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏**
   - Single-process —Ç–æ–ª—å–∫–æ (–Ω–µ—Ç horizontal scaling)
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –ø–∞–º—è—Ç–∏ (~GB –¥–∞–Ω–Ω—ã—Ö)
   - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è MVP/—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –º–∏–≥—Ä–∞—Ü–∏—è –≤ Production

4. **‚ö†Ô∏è –ù–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞**
   - Race conditions –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
   - Python GIL —á–∞—Å—Ç–∏—á–Ω–æ –∑–∞—â–∏—â–∞–µ—Ç, –Ω–æ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç
   - **–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –£–≤–µ–ª–∏—á–µ–Ω–∏–µ `--workers 1` –≤ Uvicorn (single worker)

---

## Security Impact

### –£–≥—Ä–æ–∑—ã –∏–∑ Threat Model (P04)

| –£–≥—Ä–æ–∑–∞ | –í–ª–∏—è–Ω–∏–µ In-Memory | –°–º—è–≥—á–µ–Ω–∏–µ |
|--------|-------------------|-----------|
| T5.1: Unauthorized data access | ‚ö†Ô∏è –ù–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î | FastAPI endpoints —Ä–µ–∞–ª–∏–∑—É—é—Ç –ª–æ–≥–∏–∫—É auth |
| T5.2: Data tampering | ‚ö†Ô∏è –ù–µ—Ç audit log –∏–∑–º–µ–Ω–µ–Ω–∏–π | –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –≤ PostgreSQL (triggers) |
| T7.1: Deletion of habits | ‚úÖ –õ–µ–≥–∫–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏ —Å–±–æ–µ | Soft delete –ª–æ–≥–∏–∫–∞ –≤ –∫–æ–¥–µ |
| R06: –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–±–æ–µ | ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫ | **Rollout: PostgreSQL –≤ Production** |

### –†–∏—Å–∫–∏ –∏–∑ Risk Register (P04)

| –†–∏—Å–∫ | –°—Ç–∞—Ç—É—Å | –°–º—è–≥—á–µ–Ω–∏–µ |
|------|--------|-----------|
| R06: –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö | üî• –í—ã—Å–æ–∫–∏–π –¥–ª—è Production | MVP only, PostgreSQL –≤ –ø–ª–∞–Ω–∞—Ö |
| R07: –ù–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π | üî• –í—ã—Å–æ–∫–∏–π | –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è MVP |
| T5.3: SQL Injection | ‚úÖ –ù–µ –ø—Ä–∏–º–µ–Ω–∏–º–æ | In-memory –Ω–µ –∏–º–µ–µ—Ç SQL |

**–ö–ª—é—á–µ–≤–æ–π —Ä–∏—Å–∫:** In-memory –ø–æ–¥—Ö–æ–¥–∏—Ç **—Ç–æ–ª—å–∫–æ –¥–ª—è MVP/Dev**, –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ PostgreSQL –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è Production.

---

## Implementation

### –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**–§–∞–π–ª—ã:**
- `app/main.py` (lines 30-32) ‚Äî –û–±—ä—è–≤–ª–µ–Ω–∏–µ `_HABITS_DB: Dict[str, Dict[str, Any]]`
- `app/main.py` (lines 121-125, 164-170, 228-235, 309-315) ‚Äî CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:**
```python
# app/main.py (line 30)
_HABITS_DB: Dict[str, Dict[str, Any]] = {}

# –ü—Ä–∏–º–µ—Ä –∑–∞–ø–∏—Å–∏
_HABITS_DB["550e8400-e29b-41d4-a716-446655440000"] = {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "name": "Morning Run",
    "description": "5km jog every morning",
    "frequency": "daily",
    "created_at": "2025-01-01T08:00:00Z",
    "tracking": [
        {
            "id": "tracking-uuid",
            "date": "2025-01-02",
            "completed": True,
            "notes": "Great run!"
        }
    ]
}
```

**CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏:**
```python
# –°–æ–∑–¥–∞–Ω–∏–µ (app/main.py, lines 121-125)
_HABITS_DB[habit_id] = {
    "id": habit_id,
    "name": habit_data.name,
    ...
}

# –ß—Ç–µ–Ω–∏–µ (app/main.py, line 165)
habit = _HABITS_DB.get(habit_id)

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ (app/main.py, lines 228-235)
if habit_name:
    _HABITS_DB[habit_id]["name"] = habit_name
...

# –£–¥–∞–ª–µ–Ω–∏–µ (app/main.py, line 310)
del _HABITS_DB[habit_id]
```

**–¢–µ—Å—Ç—ã:**
```python
# tests/test_habits.py ‚Äî –í—Å–µ —Ç–µ—Å—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å in-memory storage
def test_create_habit():
    response = client.post("/habits", json={"name": "Test Habit"})
    assert response.status_code == 201

def test_get_habits():
    response = client.get("/habits")
    assert response.status_code == 200
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- ‚úÖ 58 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—Ö–æ–¥—è—Ç –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- ‚úÖ Performance NFR-07/08/09 –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
- ‚ö†Ô∏è NFR-12 (Persistence) –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω (–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ)

---

## Acceptance Criteria (DoD)

**MVP —Ñ–∞–∑–∞ (–ó–∞–≤–µ—Ä—à–µ–Ω–æ ‚úÖ):**
- [x] `_HABITS_DB` –æ–±—ä—è–≤–ª–µ–Ω –≤ `app/main.py`
- [x] –í—Å–µ CRUD endpoints –∏—Å–ø–æ–ª—å–∑—É—é—Ç `_HABITS_DB`
- [x] –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –±–µ–∑ –ë–î –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- [x] –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç NFR-07/08/09
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (—ç—Ç–æ—Ç ADR)

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ PostgreSQL:**
- [ ] –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (NFR-12)
- [ ] –¢—Ä–µ–±—É–µ—Ç—Å—è audit log (T5.2)
- [ ] –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ production deployment
- [ ] –ù–µ–æ–±—Ö–æ–¥–∏–º—ã —Å–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (JOIN, –∞–≥—Ä–µ–≥–∞—Ü–∏—è)

---

## Rollout Plan

### –§–∞–∑–∞ 1: MVP (–¢–µ–∫—É—â–∞—è —Ñ–∞–∑–∞ ‚úÖ)
**Timeframe:** 2025-10-01 ‚Äî 2025-10-15

- [x] In-memory dict –¥–ª—è –≤—Å–µ—Ö CRUD –æ–ø–µ—Ä–∞—Ü–∏–π
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- [x] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- [x] –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å benchmark

**Feature Flag:**
```python
# app/config.py (–¥–ª—è –±—É–¥—É—â–µ–≥–æ)
USE_DATABASE = os.getenv("USE_DATABASE", "false").lower() == "true"
```

### –§–∞–∑–∞ 2: PostgreSQL –º–∏–≥—Ä–∞—Ü–∏—è (–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ üìã)
**Timeframe:** 2025-11-01 ‚Äî 2025-11-15

**–ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏:**
1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã**
   - –î–æ–±–∞–≤–∏—Ç—å PostgreSQL –≤ `compose.yaml`
   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å SQLAlchemy + asyncpg
   - –°–æ–∑–¥–∞—Ç—å ORM –º–æ–¥–µ–ª–∏ (app/database.py)

2. **–°–ª–æ–π –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏**
   ```python
   # app/repository.py
   class HabitRepository(Protocol):
       async def create(self, habit: HabitCreate) -> Habit: ...
       async def get(self, habit_id: str) -> Optional[Habit]: ...
       ...

   class InMemoryRepository(HabitRepository): ...
   class PostgresRepository(HabitRepository): ...
   ```

3. **–ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**
   - Alembic –¥–ª—è schema migrations
   - –°–∫—Ä–∏–ø—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞ in-memory ‚Üí PostgreSQL (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

4. **–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ**
   ```python
   # app/main.py
   if settings.USE_DATABASE:
       repo = PostgresRepository()
   else:
       repo = InMemoryRepository()
   ```

5. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
   - –î–≤–æ–π–Ω–æ–π –ø—Ä–æ–≥–æ–Ω —Ç–µ—Å—Ç–æ–≤ (in-memory –∏ PostgreSQL)
   - Performance regression —Ç–µ—Å—Ç—ã
   - Backup/restore –ø—Ä–æ—Ü–µ–¥—É—Ä—ã

**DoD –¥–ª—è PostgreSQL:**
- [ ] ORM –º–æ–¥–µ–ª–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ Alembic —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —Å PostgreSQL
- [ ] Backup —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ (NFR-13)
- [ ] Performance –Ω–µ –¥–µ–≥—Ä–∞–¥–∏—Ä—É–µ—Ç (NFR-07/08/09)

### –§–∞–∑–∞ 3: Production (–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ üìã)
**Timeframe:** 2025-12-01

- [ ] Connection pooling –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] PostgreSQL backup/restore –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ë–î –º–µ—Ç—Ä–∏–∫ (Prometheus)
- [ ] Audit log –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (T5.2)
- [ ] –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è performance

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:** NFR-12, NFR-13 –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, R06 —Å–º—è–≥—á–µ–Ω –¥–æ Low risk.

---

## Links

- **NFR –¥–æ–∫—É–º–µ–Ω—Ç—ã:** [docs/security-nfr/NFR.md](../security-nfr/NFR.md)
  - NFR-12: Data Persistence Strategy (Planned)
  - NFR-13: Backup Strategy (Planned)
- **Threat Model:** [docs/threat-model/README.md](../threat-model/README.md)
  - R06: –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–±–æ–µ
  - T5.2: –ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ audit log
- **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** [app/main.py](../../app/main.py) (line 30)
- **–¢–µ—Å—Ç—ã:** [tests/test_habits.py](../../tests/test_habits.py)
- **SQLAlchemy –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** https://docs.sqlalchemy.org/

---

## Review & Updates

| –î–∞—Ç–∞ | –ò–∑–º–µ–Ω–µ–Ω–∏–µ | –ê–≤—Ç–æ—Ä |
|------|-----------|-------|
| 2025-10-01 | –ü–µ—Ä–≤–∞—è –≤–µ—Ä—Å–∏—è ADR | SecDev Team |
| 2025-10-15 | –î–æ–±–∞–≤–ª–µ–Ω Rollout –ø–ª–∞–Ω PostgreSQL –º–∏–≥—Ä–∞—Ü–∏–∏ | SecDev Team |

---

## Notes

**–í–∞–∂–Ω–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ:** –≠—Ç–æ —Ä–µ—à–µ–Ω–∏–µ —è–≤–ª—è–µ—Ç—Å—è **–≤—Ä–µ–º–µ–Ω–Ω—ã–º** –∏ –ø–æ–¥—Ö–æ–¥–∏—Ç **—Ç–æ–ª—å–∫–æ –¥–ª—è MVP/Dev —Ñ–∞–∑—ã**. –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ PostgreSQL –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –ø–µ—Ä–µ–¥ production deployment –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è NFR-12, NFR-13 –∏ —Å–º—è–≥—á–µ–Ω–∏—è —Ä–∏—Å–∫–∞ R06.
