name: Security - SAST & Secrets

on:
  workflow_dispatch:
  push:
    paths:
      - "**/*.py"
      - "requirements*.txt"
      - "pyproject.toml"
      - "security/**"
      - ".github/workflows/ci-sast-secrets.yml"
  pull_request:
    paths:
      - "**/*.py"
      - "requirements*.txt"
      - "pyproject.toml"
      - "security/**"
      - ".github/workflows/ci-sast-secrets.yml"

permissions:
  contents: read
  security-events: write

concurrency:
  group: sast-secrets-${{ github.ref }}
  cancel-in-progress: true

env:
  EVIDENCE_DIR: EVIDENCE/P10
  SEMGREP_SARIF: EVIDENCE/P10/semgrep.sarif
  GITLEAKS_JSON: EVIDENCE/P10/gitleaks.json
  SAST_SUMMARY: EVIDENCE/P10/sast_summary.md
  SEMGREP_IMAGE: semgrep/semgrep:latest
  GITLEAKS_IMAGE: zricethezav/gitleaks:latest

jobs:
  sast-secrets:
    name: Run Semgrep & Gitleaks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare evidence directory
        run: |
          mkdir -p "$EVIDENCE_DIR"
          echo "# SAST & Secrets summary" > $SAST_SUMMARY
          echo "Run ID: $GITHUB_RUN_ID" >> $SAST_SUMMARY
          echo "Commit: $GITHUB_SHA" >> $SAST_SUMMARY
          echo "Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $SAST_SUMMARY
          echo "" >> $SAST_SUMMARY

      - name: Semgrep (SAST)
        run: |
          docker run --rm -v "${PWD}:/src" -w /src $SEMGREP_IMAGE \
            semgrep --config p/ci --config security/semgrep/rules.yml \
            --sarif --output "$SEMGREP_SARIF" --exit-zero --metrics=off --timeout=180

      - name: Gitleaks (Secrets)
        run: |
          docker run --rm -v "${PWD}:/repo" -w /repo $GITLEAKS_IMAGE \
            detect --source . --config security/.gitleaks.toml \
            --report-format json --report-path "$GITLEAKS_JSON" || true

      - name: Summaries
        run: |
          echo "## Semgrep" >> $SAST_SUMMARY
          if command -v jq >/dev/null 2>&1; then
            jq -r '.["runs"][0].results | length // 0' "$SEMGREP_SARIF" | {
              read count || true
              echo "Findings: ${count:-0}" >> $SAST_SUMMARY
            }
          else
            echo "jq not available" >> $SAST_SUMMARY
          fi
          echo "\n## Gitleaks" >> $SAST_SUMMARY
          if command -v jq >/dev/null 2>&1; then
            jq -r '.findings | length // 0' "$GITLEAKS_JSON" | {
              read count || true
              echo "Findings: ${count:-0}" >> $SAST_SUMMARY
            }
          else
            echo "jq not available" >> $SAST_SUMMARY
          fi
          echo "\nArtifacts stored under $EVIDENCE_DIR" >> $SAST_SUMMARY

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sast-secrets-${{ github.run_id }}
          path: |
            ${{ env.SEMGREP_SARIF }}
            ${{ env.GITLEAKS_JSON }}
            ${{ env.SAST_SUMMARY }}

      - name: Upload Semgrep SARIF to Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ env.SEMGREP_SARIF }}
        continue-on-error: true

      - name: Job summary
        run: |
          echo "## SAST & Secrets" >> $GITHUB_STEP_SUMMARY
          echo "- Semgrep SARIF: $SEMGREP_SARIF" >> $GITHUB_STEP_SUMMARY
          echo "- Gitleaks report: $GITLEAKS_JSON" >> $GITHUB_STEP_SUMMARY
          echo "- Summary: $SAST_SUMMARY" >> $GITHUB_STEP_SUMMARY
          echo "- Artifact: sast-secrets-${GITHUB_RUN_ID}" >> $GITHUB_STEP_SUMMARY
